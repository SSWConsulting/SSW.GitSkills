<BarChart @ref="barChart" TItem="int" />

<p>Datasets:</p>
<p>
    <ul>
    @foreach (var ds in datasets)
    {
        <li>@ds.Label</li>
    }
    </ul>
</p>

<p>Labels:</p>
<p>
    <ul>
    @foreach (var label in Labels)
    {
        <li>@label</li>
    }
    </ul>
</p>

@code{
    BarChart<int> barChart;

    private List<BarChartDataset<int>> datasets { get; set; } = new List<BarChartDataset<int>>();
    
    [Parameter]
    public List<string> Labels { get; set; }

    [Parameter]
    public EventCallback<List<string>> LabelsChanged { get; set; }

    private async Task OnLabelsChanged(ChangeEventArgs e)
    {
        var theList = e.Value as List<string>;
        Labels = theList;
        await LabelsChanged.InvokeAsync(Labels);
    }

    public async Task AddSeries (string Label, List<int> Values)
    {
        SeedChartColors(Values.Count);

        var ds = new BarChartDataset<int>
        {
            Label = Label,
            Data = Values,
            BackgroundColor = backgroundColors,
            BorderColor = borderColors
        };

        datasets.Add(ds);
        await HandleRedraw();
    }

    public async Task RemoveSeries(string label)
    {
        var ds = datasets.Where(d => d.Label == label).FirstOrDefault();
        datasets.Remove(ds);
        await HandleRedraw();
    }

    List<string> borderColors { get; set; }
    List<string> backgroundColors { get; set; }

    public async Task RedrawChart()
    {
        await HandleRedraw();
    }

    async Task HandleRedraw()
    {
        await barChart.Clear();

        await barChart.AddLabelsDatasetsAndUpdate( GetChartLabels(), datasets.ToArray() );        
    }

    string[] GetChartLabels()
    {
        return Labels.ToArray();
    }

    void SeedChartColors(int count)
    {
        var r = new Random( DateTime.Now.Millisecond );

        backgroundColors = new List<string> ();
        
        borderColors = new List<string>();

        for(int i = 0; i < count; i++ )
        {
            var r1 = Convert.ToByte(r.Next(0, 255));
            var r2 = Convert.ToByte(r.Next(0, 255));
            var r3 = Convert.ToByte(r.Next(0, 255));

            var backCol = ChartColor.FromRgba(r1, r2, r3, 0.2f);
            var borderCol = ChartColor.FromRgba(r1, r2, r3, 1f);

            backgroundColors.Add(backCol);
            borderColors.Add(borderCol);
        }
    }
}